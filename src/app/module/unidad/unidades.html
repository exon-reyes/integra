<app-title
    description="Administra la información básica de las unidades"
    iconClass="i-contact"
    title="Catálago de Unidades"/>
<div class="grid grid-cols-1 gap-8 md:grid-cols-3 my-4">
    <div class="bg-surface-0 dark:bg-surface-900 shadow-sm p-5 rounded-xl">
        <div class="flex justify-between gap-4">
            <div class="flex flex-col gap-2">
                <span class="text-surface-700 dark:text-surface-300 font-normal leading-tight">Unidades activas</span>
                <div
                    class="text-surface-900 dark:text-surface-0 font-semibold text-2xl! leading-tight!">{{ stats().activas }}
                </div>
            </div>
            <div
                class="flex items-center justify-center bg-linear-to-b from-cyan-400 to-cyan-600 rounded-lg w-10 h-10">
                <i class="pi pi-building text-surface-0 dark:text-surface-900 text-xl! leading-none!"></i>
            </div>
        </div>
        <div class="mt-4">
            <span class="text-surface-600 dark:text-surface-300 font-medium leading-tight">{{ stats().activas }}
                disponibles</span>
            <span class="text-surface-500 dark:text-surface-300 leading-tight"> de {{ stats().total }}
                registradas</span>
        </div>
    </div>

    <div class="bg-surface-0 dark:bg-surface-900 shadow-sm p-5 rounded-xl">
        <div class="flex justify-between gap-4">
            <div class="flex flex-col gap-2">
                <span class="text-surface-700 dark:text-surface-300 font-normal leading-tight">Unidades inactivas</span>
                <div
                    class="text-surface-900 dark:text-surface-0 font-semibold text-2xl! leading-tight!">{{ stats().inactivas }}
                </div>
            </div>
            <div
                class="flex items-center justify-center bg-linear-to-b from-orange-400 dark:from-orange-300 to-orange-600 dark:to-orange-500 rounded-lg w-10 h-10">
                <i class="pi pi-arrow-circle-down text-surface-0 dark:text-surface-900 text-xl! leading-none!"></i>
            </div>
        </div>
        <div class="mt-4">
            <span class="text-surface-500 dark:text-surface-300 leading-tight">Por cambio de razón social o estado pausado</span>
        </div>
    </div>

    <div class="bg-surface-0 dark:bg-surface-900 shadow-sm p-5 rounded-xl">
        <div class="flex justify-between gap-4">
            <div class="flex flex-col gap-2">
                <span
                    class="text-surface-700 dark:text-surface-300 font-normal leading-tight">Unidades sincronizadas</span>
                <div
                    class="text-surface-900 dark:text-surface-0 font-semibold text-2xl! leading-tight!">{{ stats().total }}
                </div>
            </div>
            <div
                class="flex items-center justify-center bg-linear-to-b from-slate-400 dark:from-slate-300 to-slate-600 dark:to-slate-500 rounded-lg w-10 h-10">
                <i class="pi pi-cloud-download text-surface-0 dark:text-surface-900 text-xl! leading-none!"></i>
            </div>
        </div>
        <div class="mt-4">
            <span
                class="text-surface-500 dark:text-surface-300 leading-tight">Última sincronización {{ ultimaSincronizacion() | date: 'short' }}</span>
        </div>
    </div>
</div>
<p-panel header="Filtros de consulta">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <p-iconfield>
                <p-inputicon class="pi pi-search"/>
                <input (input)="dt.filterGlobal($any($event.target).value, 'contains')" [(ngModel)]="searchValue"
                       class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                       pInputText
                       placeholder="Buscar unidades..."/>
            </p-iconfield>
        </div>
        <div>
            <p-select (onChange)="onSupervisorChange($event.value)" [ngModel]="filtroSupervisor()"
                      [options]="supervisores()" [showClear]="true"
                      class="w-full" optionLabel="nombreCompleto"
                      optionValue="nombreCompleto" placeholder="Todos los supervisores">
            </p-select>
        </div>
        <div>
            <p-select (onChange)="onZonaChange($event.value)" [ngModel]="filtroZona()"
                      [options]="zonas()" [showClear]="true"
                      class="w-full" optionLabel="nombre"
                      optionValue="nombre" placeholder="Todas las zonas">
            </p-select>
        </div>
        <div>
            <p-select (onChange)="onEstatusChange($event.value)" [ngModel]="filtroEstatus()"
                      [options]="estatusOptions" [showClear]="true"
                      class="w-full" optionLabel="label"
                      optionValue="value" placeholder="Todos los estados">
            </p-select>
        </div>
    </div>
</p-panel>
<div class="bg-white shadow-sm rounded-lg border border-gray-100 mt-1">
    <p-table #dt [globalFilterFields]="['nombre','clave']" [paginator]="true" [rows]="50"
             [scrollable]="true" [value]="unidadesFiltradas()" class="border-0"
             scrollHeight="calc(100vh - 438px)">
        <ng-template #caption>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex gap-2">
                    <p-button (onClick)="openCreateDialog()" *hasPermission="Autoridades.CREAR_UNIDAD" icon="pi pi-plus"
                              label="Agregar"
                              size="small"></p-button>
                    <p-button (onClick)="sincronizar()" icon="pi pi-sync" label="Sincronizar"
                              size="small"></p-button>

                    <p-button
                        (onClick)="abrirDilogZonas()"
                        *hasPermission="[Autoridades.CREAR_ZONA,Autoridades.ELIMINAR_ZONA,Autoridades.EDITAR_ZONA]"
                        icon="pi pi-map-marker" label="Zonas"
                        size="small"></p-button>
                </div>
                <div class="flex gap-2">
                    <p-button (onClick)="exportarExcel()" *hasPermission="Autoridades.EXPORTAR_UNIDAD"
                              [loading]="exporting()" icon="pi pi-file-excel"
                              label="Exportar"
                              size="small"></p-button>

                </div>

            </div>
        </ng-template>
        <ng-template #header>
            <tr class="bg-gray-50">
                <th class="font-medium py-3 px-4">Nombre</th>
                <th class="font-medium  py-3 px-4">Supervisor</th>
                <th class="font-medium  py-3 px-4">Zona</th>
                <th class="font-medium py-3 px-4">Estado</th>
                <th class="font-medium  py-3 px-4 w-32">Acciones</th>
            </tr>
        </ng-template>
        <ng-template #body let-unidad>
            <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="py-3 px-4 font-medium">{{ unidad.clave }} {{ unidad.nombre }}</td>
                <td>{{ unidad.supervisor?.nombreCompleto }}</td>
                <td class="py-3 px-4 text-gray-600">{{ unidad.contacto?.zona?.nombre }}</td>
                <td class="py-3 px-4">
          <span
              class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium {{ unidad.activo ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' }}">
            <i class="pi {{ unidad.activo ? 'pi-check-circle' : 'pi-arrow-circle-down' }}"></i>
              {{ unidad.activo ? 'Activo' : 'Inactivo' }}
          </span>
                </td>
                <td class="py-3 px-4">
                    <div class="flex gap-1">
                        <p-button (click)="openEditDialog(unidad)" *hasPermission="Autoridades.EDITAR_UNIDAD"
                                  [outlined]="true" [rounded]="true"
                                  icon="pi pi-pen-to-square" severity="info" size="small"
                                  styleClass="p-2 hover:bg-blue-50 transition-colors duration-200"></p-button>
                        <p-button (click)="deleteUnidad(unidad)" *hasPermission="Autoridades.ELIMINAR_UNIDAD"
                                  [outlined]="true" [rounded]="true" icon="pi pi-trash"
                                  severity="danger" size="small"
                                  styleClass="p-2 hover:bg-red-50 transition-colors duration-200"></p-button>
                        @if (!unidad.activo) {
                            <p-button *hasPermission="Autoridades.EDITAR_UNIDAD" (click)="toggleStatus(unidad)"
                                      icon="pi pi-play" size="small" severity="warn"
                                      [rounded]="true" [outlined]="true"
                                      styleClass="p-2 hover:bg-orange-50 transition-colors duration-200"></p-button>
                        }
                        <p-button (click)="abrirInfoGeneral(unidad.id)" [outlined]="true"
                                  [rounded]="true" icon="pi pi-info-circle" severity="help"
                                  size="small"
                                  styleClass="p-2 hover:bg-gray-50 transition-colors duration-200"></p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<app-agregar-unidad
    [(visible)]="mostrarAgregarUnidad"
    (unidadCreada)="onUnidadCreada()">
</app-agregar-unidad>

@if (!saving()) {
    <p-dialog [(visible)]="displayDialog" header="Editar Unidad"
              *hasPermission="Autoridades.EDITAR_UNIDAD"
              [modal]="true" [style]="{ width: '45rem' }" [closable]="true" [draggable]="false"
              styleClass="rounded-lg">
        <form [formGroup]="form" (ngSubmit)="saveUnidad()" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Clave *</label>
                    <input type="text" formControlName="clave" pInputText
                           class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Clave">
                    @if (form.get('clave')?.invalid && form.get('clave')?.touched) {
                        <small class="text-red-500 text-xs">Requerida, máx. 10 caracteres</small>
                    }
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" formControlName="nombre" pInputText
                           class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Nombre">
                    @if (form.get('nombre')?.invalid && form.get('nombre')?.touched) {
                        <small class="text-red-500 text-xs">Requerido, máx. 100 caracteres</small>
                    }
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                    <p-select [options]="estados()" formControlName="idEstado" optionLabel="nombre" optionValue="id"
                              class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 transition-all duration-200"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Zona *</label>
                    <p-select [options]="zonas()" formControlName="idZona" optionLabel="nombre" optionValue="id"
                              class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 transition-all duration-200"/>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="text" formControlName="telefono" pInputText
                           class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Teléfono">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" formControlName="email" pInputText
                           class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Email">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                <textarea formControlName="direccion" rows="4" pTextarea
                          class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                          placeholder="Dirección"></textarea>
            </div>

            <div class="flex items-center gap-2">
                <input type="checkbox" id="activo" formControlName="activo"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="activo" class="text-sm text-gray-700">Unidad activa</label>
            </div>
        </form>

        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <p-button label="Cancelar" icon="pi pi-times" severity="secondary" (onClick)="displayDialog = false"
                          styleClass="px-4 py-2 rounded-md transition-colors duration-200"></p-button>
                <p-button label="Guardar" icon="pi pi-check" severity="success" (onClick)="saveUnidad()"
                          *hasPermission="Autoridades.EDITAR_UNIDAD"
                          styleClass="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors duration-200"></p-button>
            </div>
        </ng-template>
    </p-dialog>
} @else {
    <app-spinner [modal]="true"></app-spinner>
}

@defer (when displayZonasDialog; prefetch when displayZonasDialog) {
    <p-dialog
        [resizable]="false"
        [modal]="true"
        [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{ width: '50vw' }"
        [maximizable]="true"
        appendTo="body"
        [(visible)]="displayZonasDialog"
        [contentStyle]="{ height: '85vh' }"
        header="Zonas Operativas">
        <app-zonas></app-zonas>
    </p-dialog>
} @loading {
    <app-spinner [modal]="true"></app-spinner>
}
@defer (when openGeneralDialog; prefetch on idle) {
    <p-dialog [(visible)]="openGeneralDialog" [breakpoints]="{ '1199px': '75vw', '575px': '98vw' }"
              [style]="{ width: '50vw' }" header="Generales" [modal]="true">
        @if (openGeneralDialog) {
            <app-contacto [id-unidad]="unidadSeleccionada"></app-contacto>
            <app-operatividad [id-unidad]="unidadSeleccionada"></app-operatividad>
        }
    </p-dialog>
} @loading {
    <app-spinner [modal]="true"></app-spinner>
}
