<p-toast></p-toast>
<app-title title="Gestión de Roles"
           iconClass="isc i-exchange"
           description="Administración jerárquica de roles, módulos y permisos del sistema"/>

@if (loading()) {
    <div class="flex items-center justify-center h-96">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Cargando roles...</p>
        </div>
    </div>
} @else {
    <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 mt-3 h-[calc(100vh-144px)]">
        <!-- Panel Izquierdo: Lista de Roles -->
        <div class="xl:col-span-3 bg-white rounded-2xl h-full shadow-sm border border-gray-200/60 overflow-hidden">
            <!-- Header del Panel -->
            <div class="px-6 py-4 bg-white border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-xl font-semibold text-gray-800">Roles del Sistema</div>
                        <p class="text-sm text-gray-600 mt-1">Configura accesos</p>
                    </div>
                    <div class="p-2 bg-gray-100 rounded-lg text-center">
                        <div class="text-lg font-bold text-gray-900 leading-none">{{ roles().length }}</div>
                        <div class="text-xs text-gray-500 mt-0.5">Total</div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Roles -->
            <div class="overflow-y-auto">
                <p-table [value]="roles()" [scrollable]="true" scrollHeight="flex" styleClass="p-datatable-sm"
                         [tableStyle]="{ 'min-width': '100%' }">
                    <ng-template pTemplate="header">
                        <tr class="bg-gray-50/50">
                            <th class="py-3 px-6 text-xs font-semibold text-gray-600 uppercase tracking-wider">Rol</th>
                            <th class="py-3 px-4 text-xs font-semibold text-gray-600 uppercase tracking-wider text-center w-20">
                                Estado
                            </th>
                        </tr>
                    </ng-template>

                    <ng-template let-rol pTemplate="body">
                        <tr class="border-b border-gray-50 cursor-pointer transition-all duration-200"
                            [class.bg-blue-50]="selectedRol()?.id === rol.id"
                            [class.hover:bg-gray-50]="selectedRol()?.id !== rol.id" (click)="selectRol(rol)">
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-9 h-9 rounded-lg flex items-center justify-center text-sm font-semibold transition-colors"
                                        [class.bg-blue-100]="selectedRol()?.id === rol.id"
                                        [class.text-blue-700]="selectedRol()?.id === rol.id"
                                        [class.bg-gray-100]="selectedRol()?.id !== rol.id"
                                        [class.text-gray-600]="selectedRol()?.id !== rol.id"
                                    >
                                        {{ rol.nombre.charAt(0).toUpperCase() }}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900 text-sm">{{ rol.nombre }}</div>
                                        <p class="text-xs text-gray-500 mt-0.5">{{ rol.descripcion || 'Sin descripción' }}</p>
                                    </div>
                                </div>
                            </td>

                            <td class="px-4 py-4 text-center">
                                <span
                                    class="inline-flex items-center justify-center w-7 h-7 rounded-lg transition-colors"
                                    [class.bg-blue-100]="selectedRol()?.id === rol.id"
                                    [class.bg-gray-100]="selectedRol()?.id !== rol.id">
                                    <i
                                        class="pi text-xs transition-colors"
                                        [class.pi-check]="selectedRol()?.id === rol.id"
                                        [class.text-blue-600]="selectedRol()?.id === rol.id"
                                        [class.pi-angle-right]="selectedRol()?.id !== rol.id"
                                        [class.text-gray-400]="selectedRol()?.id !== rol.id"
                                    ></i>
                                </span>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="2" class="text-center py-12">
                                <div class="flex flex-col items-center justify-center text-gray-400">
                                    <i class="pi pi-inbox text-4xl mb-3"></i>
                                    <p class="text-sm font-medium">No hay roles disponibles</p>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>

        <!-- Panel Derecho: GESTIÓN DE PERMISOS CON PESTAÑAS (TABS) -->
        <div class="xl:col-span-9 bg-white rounded-2xl shadow-sm border border-gray-200/60 overflow-hidden">
            @if (selectedRol()) {
                <!-- Header con Información del Rol Seleccionado -->
                <div class="px-6 py-4 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                                <span class="text-lg font-bold text-blue-700">
                                    {{ selectedRol()!.nombre.charAt(0).toUpperCase() }}
                                </span>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-gray-900">{{ selectedRol()!.nombre }}</div>
                                <p class="text-sm text-gray-500 mt-0.5">Configurar permisos y accesos del rol</p>
                            </div>
                        </div>

                        <!-- Contador de Permisos Activos -->
                        <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-xl border border-gray-200">
                            <i class="pi pi-check-circle text-green-600"></i>
                            <span class="text-sm font-semibold text-gray-700"> {{ contarPermisosActivos() }}
                                Activos </span>
                        </div>
                    </div>
                </div>

                <!-- ESTRUCTURA P-TABS PARA NAVEGACIÓN POR MÓDULO -->
                <div>
                    <p-tabs value="1">
                        <p-tablist>
                            <!-- Pestañas (Módulos) - CAMBIADO A modulos() -->
                            @for (modulo of modulos(); track modulo.id) {
                                <p-tab [value]="modulo.id.toString()">
                                    {{ modulo.nombre }}
                                </p-tab>
                            }
                        </p-tablist>

                        <p-tabpanels>
                            <!-- Contenido de cada Pestaña (Matriz Plana) - CAMBIADO A modulos() -->
                            @for (modulo of modulos(); track modulo.id) {
                                <p-tabpanel [value]="modulo.id.toString()">
                                    <div class="overflow-y-auto" style="max-height: calc(100vh - 160px);">
                                        <!-- INICIO: MATRIZ PLANA DE SUBMÓDULOS Y PERMISOS DENTRO DEL MÓDULO -->
                                        <!-- Aplicando grid para 2 columnas de SUBMÓDULOS -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            @for (submodulo of modulo.submodulos; track submodulo.id) {
                                                <div
                                                    class="border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                                                    <!-- Header del Submódulo (Título de la Matriz Local) -->
                                                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                                                        <div class="flex items-center justify-between">
                                                            <div
                                                                class="font-semibold text-gray-800 text-sm flex items-center gap-2">
                                                                <i class="pi pi-folder text-blue-600"></i>
                                                                {{ submodulo.nombre }}
                                                                <span
                                                                    class="text-xs text-gray-500 ml-2 font-normal"> ({{ contarPermisosActivosSubmodulo(submodulo) }}
                                                                    de {{ submodulo.permisos.length }} permisos) </span>
                                                            </div>
                                                            <!-- Checkbox para seleccionar todos -->
                                                            <div class="flex items-center gap-2">
                                                                <label
                                                                    class="text-xs text-gray-600 cursor-pointer select-none"
                                                                    [for]="'select-all-' + submodulo.id"> Todos </label>
                                                                <input
                                                                    type="checkbox"
                                                                    [id]="'select-all-' + submodulo.id"
                                                                    [checked]="todosPermisosSeleccionados(submodulo)"
                                                                    [indeterminate]="algunosPermisosSeleccionados(submodulo)"
                                                                    (change)="toggleTodosPermisos(submodulo, modulo)"
                                                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Lista de Permisos (Cuerpo de la Matriz Local) - Vuelve a una columna -->
                                                    <div class="p-3">
                                                        @for (permiso of submodulo.permisos; track permiso.id) {
                                                            <div
                                                                class="flex items-center justify-between px-3 py-2 rounded-lg hover:bg-blue-50 transition-all group">
                                                                <label
                                                                    class="flex-1 text-sm text-gray-700 cursor-pointer font-medium select-none"
                                                                    [for]="'permiso-' + permiso.id">
                                                                    <span
                                                                        class="flex items-center gap-2.5 group-hover:text-gray-900 transition-colors">
                                                                        {{ permiso.nombre }}
                                                                    </span>
                                                                </label>

                                                                <!-- CHECKBOX ESTILIZADO -->
                                                                <input
                                                                    type="checkbox"
                                                                    [id]="'permiso-' + permiso.id"
                                                                    [checked]="permiso.asignado"
                                                                    (change)="togglePermiso(permiso, submodulo, modulo)"
                                                                    class="h-5 w-5 rounded-md border-gray-300 text-green-600 focus:ring-green-500 cursor-pointer transition-colors shadow-sm"
                                                                />
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        <!-- FIN: MATRIZ PLANA DE SUBMÓDULOS Y PERMISOS DENTRO DEL MÓDULO -->
                                    </div>
                                </p-tabpanel>
                            }
                        </p-tabpanels>
                    </p-tabs>
                </div>
            } @else {
                <!-- Estado Vacío: Sin Rol Seleccionado -->
                <div class="flex flex-col items-center justify-center h-full py-20 px-6">
                    <div
                        class="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center mb-6">
                        <i class="pi pi-shield text-4xl text-blue-500"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Selecciona un Rol</h3>
                    <p class="text-gray-500 text-center max-w-md">Elige un rol del panel izquierdo para configurar sus
                        permisos organizados por módulos y submódulos</p>
                </div>
            }
        </div>
    </div>
}
