<app-title
    imageSrc="assets/icon/timelimit.svg"
    title="OpenTime"
    description="Gestiona el reloj checador y tiempos de compensación"/>

@if (loading()) {
    <div class="flex justify-center items-center py-12">
        <div class="animate-spin h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full"></div>
        <span class="ml-3 text-gray-600">Cargando kioscos...</span>
    </div>
} @else {
    <!-- Estadísticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 my-4">
        <!-- Total Kioscos -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center gap-4">
            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                <i class="pi pi-building text-blue-600 text-lg"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-blue-800">{{ totalKioscos() }}</div>
                <div class="text-sm text-blue-600 font-medium">Total kioscos</div>
            </div>
        </div>

        <!-- Con cámara -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-4">
            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                <i class="pi pi-camera text-green-600 text-lg"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-green-800">{{ kioscosConCamara() }}</div>
                <div class="text-sm text-green-600 font-medium">
                    Con cámara ({{ porcentajeConCamara() }}%)
                </div>
            </div>
        </div>

        <!-- Sin cámara -->
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 flex items-center gap-4">
            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                <i class="pi pi-eye-slash text-orange-600 text-lg"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-orange-800">{{ kioscosSinCamara() }}</div>
                <div class="text-sm text-orange-600 font-medium">
                    Sin cámara ({{ 100 - porcentajeConCamara() }}%)
                </div>
            </div>
        </div>

        <!-- Con compensación -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 flex items-center gap-4">
            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm">
                <i class="pi pi-clock text-purple-600 text-lg"></i>
            </div>
            <div>
                <div class="text-2xl font-bold text-purple-800">{{ kioscosConCompensacion() }}</div>
                <div class="text-sm text-purple-600 font-medium">
                    Con compensación
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de kioscos -->
    <div class="bg-white shadow-sm rounded-lg border border-gray-100">

        <div class="p-4 border-b border-gray-100">
            <div class="flex gap-2 justify-between">
                <p-iconfield>
                    <p-inputicon class="pi pi-search"/>
                    <input (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                           class="w-full border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           pInputText
                           placeholder="Buscar unidad..."/>
                </p-iconfield>
                <p-button
                    (onClick)="cargarKioscos()"
                    icon="pi pi-refresh"
                    label="Actualizar"
                    severity="info"
                    size="small"
                    [loading]="loading()">
                </p-button>

            </div>
        </div>

        <p-table #dt
                 [value]="kioscos()"
                 [paginator]="true"
                 [globalFilterFields]="['nombreCompleto']"
                 [rows]="50"
                 [scrollable]="true"
                 scrollHeight="calc(100vh - 331px)"
                 [showCurrentPageReport]="true"
                 currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} kioscos"
                 class="border-0">

            <ng-template pTemplate="header">
                <tr class="bg-gray-50">
                    <th class="py-3 px-4">#</th>
                    <th class="py-3 px-4" pSortableColumn="nombreCompleto">Unidad
                        <p-sortIcon field="nombreCompleto"/>
                    </th>
                    <th class="py-3 px-4 text-center" pSortableColumn="requiereCamara"> Requiere Cámara
                        <p-sortIcon field="requiereCamara"/>
                    </th>
                    <th>Solicitud config. manual</th>
                    <th>Código confirmación</th>
                    <th>Tiempo Comp. Depósito</th>
                </tr>
            </ng-template>

            <ng-template let-kiosco pTemplate="body" let-rowIndex="rowIndex">
                <tr class="text-sm hover:bg-gray-50 transition-colors">
                    <td>{{ rowIndex + 1 }}</td>
                    <td>{{ kiosco.nombreCompleto }}</td>
                    <td>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input
                                type="checkbox"
                                [checked]="kiosco.requiereCamara"
                                (change)="actualizarEstatusCamara(kiosco)"
                                class="sr-only peer">
                            <div
                                class="w-9 h-5 bg-gray-200 hover:bg-gray-300 peer-focus:outline-0 peer-focus:ring-transparent rounded-full peer transition-all ease-in-out duration-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600 hover:peer-checked:bg-indigo-700"></div>
                        </label>
                    </td>
                    <td class="text-center">
                        @if (kiosco.requiereReset) {
                            <div class="flex gap-2 justify-center">
                                <p-button
                                    (onClick)="generarCodigoConfig(kiosco)"
                                    icon="pi pi-check"
                                    severity="success"
                                    size="small"
                                    [text]="true"
                                    pTooltip="Aprobar solicitud">
                                </p-button>
                                <p-button
                                    (onClick)="rechazarSolicitudCodigo(kiosco)"
                                    icon="pi pi-times"
                                    severity="danger"
                                    size="small"
                                    [text]="true"
                                    pTooltip="Rechazar solicitud">
                                </p-button>
                            </div>
                        } @else {
                            <span class="text-gray-400">-</span>
                        }
                    </td>
                    <td class="text-center">
                        @if (kiosco.codigoAutorizacionKiosco) {
                            <span
                                class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{{ kiosco.codigoAutorizacionKiosco }}</span>
                        } @else {
                            <span class="text-gray-400">-</span>
                        }
                    </td>
                    <td>
                        @if (editandoCompensacion() === kiosco.id) {
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1">
                                    <input
                                        type="number"
                                        [(ngModel)]="horasTemp"
                                        class="w-12 px-1 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                                        min="0" max="23" placeholder="0">
                                    <span class="text-xs text-gray-500">h</span>
                                    <input
                                        type="number"
                                        [(ngModel)]="minutosTemp"
                                        class="w-12 px-1 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                                        min="0" max="59" placeholder="0">
                                    <span class="text-xs text-gray-500">m</span>
                                </div>
                                <p-button
                                    (onClick)="guardarCompensacion(kiosco)"
                                    icon="pi pi-check"
                                    severity="success"
                                    size="small"
                                    [text]="true">
                                </p-button>
                                <p-button
                                    (onClick)="cancelarEdicionCompensacion()"
                                    icon="pi pi-times"
                                    severity="secondary"
                                    size="small"
                                    [text]="true">
                                </p-button>
                            </div>
                        } @else {
                            <div class="flex items-center gap-2">
                                <span class="font-mono text-sm">{{ kiosco.tiempoCompensacion || '00:00' }}</span>
                                <p-button
                                    (onClick)="iniciarEdicionCompensacion(kiosco)"
                                    icon="pi pi-pencil"
                                    severity="secondary"
                                    size="small"
                                    [text]="true"
                                    pTooltip="Editar tiempo">
                                </p-button>
                            </div>
                        }
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        <i class="pi pi-inbox text-4xl mb-2 block"></i>
                        <div>No hay kioscos registrados</div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
}
