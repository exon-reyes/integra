<div class="py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <app-title
            description="Registro de entradas, salidas del colaborador por eventualidad"
            imageSrc="assets/icon/touch.svg"
            title="Registro manual de asistencia">
        </app-title>

        <div class="mt-4 bg-white rounded-2xl shadow-xl border border-slate-200 p-6 sm:p-7">

            @if (error()) {
                <div class="flex items-start gap-3 p-3 mb-5 bg-red-50 border border-red-300 rounded-lg">
                    <i class="pi pi-exclamation-circle text-red-500 text-base mt-0.5 flex-shrink-0"></i>
                    <span class="text-sm text-red-800 font-medium">{{ error() }}</span>
                </div>
            }

            @if (success()) {
                <div class="flex items-start gap-3 p-3 mb-5 bg-emerald-50 border border-emerald-300 rounded-lg">
                    <i class="pi pi-check-circle text-emerald-500 text-base mt-0.5 flex-shrink-0"></i>
                    <span class="text-sm text-emerald-800 font-medium">{{ success() }}</span>
                </div>
            }

            <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200" [formGroup]="busquedaForm">
                <label class="block text-sm font-semibold text-slate-700 mb-2" for="nip-input">
                    PIN del Colaborador
                </label>
                <div class="flex gap-3">
                    <input
                        pInputText
                        (keyup.enter)="buscarEmpleado()"
                        formControlName="nipBusqueda"
                        id="nip-input"
                        maxlength="8"
                        class="w-full "
                        placeholder="Ingrese PIN de asistencia"
                        type="text">

                    <p-button
                        (onClick)="buscarEmpleado()"
                        [loading]="isLoading()"
                        [disabled]="isLoading() || busquedaForm.invalid"
                        icon="pi pi-search"
                        label="Consultar">
                    </p-button>
                </div>
            </div>

            @if (empleadoBuscado()) {
                <div class="bg-gray-100 rounded-lg p-4 mb-6 border-slate-100">
                    <div class="flex items-center justify-between gap-4">

                        <div class="flex items-center gap-4 flex-shrink-0 min-w-0">

                            <div class="flex items-center justify-center w-12 h-12 bg-white rounded-full flex-shrink-0 border border-slate-200 shadow-sm">
                                <i class="pi pi-user text-slate-600 text-xl"></i>
                            </div>

                            <div class="min-w-0">
                                <div class="text-lg sm:text-xl font-extrabold text-slate-900 truncate leading-tight">
                                    {{ empleadoBuscado()!.nombre }}
                                </div>

                                <div class="flex flex-wrap items-center gap-x-2 mt-1">
                                    <span class="text-xs text-slate-500 font-medium tracking-wider">
                                        CLAVE: <strong class="text-slate-700">{{ empleadoBuscado()!.clave }}</strong>
                                    </span>

                                    <span class="text-slate-300">|</span>

                                    @if (empleadoBuscado()!.jornadaIniciada) {
                                        <span class="text-xs font-medium flex items-center gap-1">
                                            El colaborador está laborando
                                        </span>
                                    } @else {
                                        <span class="text-xs font-medium flex items-center gap-1">
                                            Esperando registro de entrada
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="flex-shrink-0 self-center">
                            @if (empleadoBuscado()!.jornadaIniciada) {
                                @if (pausaActivaTexto()) {
                                    <span class="shadow-sm inline-flex items-center gap-2 px-3 py-1.5 bg-orange-50 text-orange-700 rounded-full text-xs font-bold whitespace-nowrap">
                                        EN PAUSA: {{ pausaActivaTexto()?.toUpperCase() }}
                                    </span>
                                } @else {
                                    <span class=" shadow-sm inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full text-xs font-bold whitespace-nowrap">
                                        <span class="relative flex h-2 w-2">
                                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                          <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                        </span>
                                        JORNADA EN CURSO
                                    </span>
                                }
                            } @else {
                                <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full text-xs font-bold border border-slate-200 whitespace-nowrap">
                                    <i class="pi pi-clock text-[10px]"></i>
                                    SIN JORNADA
                                </span>
                            }
                        </div>

                    </div>
                </div>

                <div class="space-y-6" [formGroup]="registroForm">
                    <h6 class="text-xl font-semibold text-slate-900 border-b border-slate-200 pb-2">
                        Datos de registro
                    </h6>

                    <div>
                        <label for="unidad" class="block text-sm font-medium text-slate-700 mb-2">
                            Unidad donde se registrará al colaborador
                        </label>
                        <p-select
                            formControlName="unidadId"
                            [options]="unidades()"
                            optionLabel="nombreCompleto"
                            optionValue="id"
                            placeholder="Seleccione una unidad"
                            [ngClass]="{
                                'ng-invalid ng-dirty': registroForm.get('unidadId')?.invalid && registroForm.get('unidadId')?.touched
                            }"
                            class="w-full">
                        </p-select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">
                            Tipo de Acción
                        </label>

                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            @for (tipo of tiposAccion(); track tipo.value) {
                                <div
                                    (click)="seleccionarAccion(tipo.value)"
                                    class="relative group cursor-pointer rounded-xl border-2 p-4 flex flex-col items-center justify-center gap-3 transition-all duration-200"
                                    [ngClass]="{
                        'border-blue-500 bg-blue-50/50 text-blue-700 shadow-sm ring-1 ring-blue-500/20': registroForm.get('tipoAccion')?.value === tipo.value,
                        'border-slate-200 bg-white text-slate-600 hover:border-blue-300 hover:bg-slate-50 hover:shadow-sm': registroForm.get('tipoAccion')?.value !== tipo.value
                    }">

                                    <div class="flex items-center justify-center w-10 h-10 rounded-full transition-colors"
                                         [ngClass]="{
                            'bg-blue-100 text-blue-600': registroForm.get('tipoAccion')?.value === tipo.value,
                            'bg-slate-100 text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-500': registroForm.get('tipoAccion')?.value !== tipo.value
                        }">
                                        @if (tipo.label.toLowerCase().includes('entrada') || tipo.label.toLowerCase().includes('inicio')) {
                                            <i class="pi pi-sign-in text-xl"></i>
                                        } @else if (tipo.label.toLowerCase().includes('salida') || tipo.label.toLowerCase().includes('fin')) {
                                            <i class="pi pi-sign-out text-xl"></i>
                                        } @else if (tipo.label.toLowerCase().includes('pausa') || tipo.label.toLowerCase().includes('comer')) {
                                            <i class="pi pi-pause text-xl"></i>
                                        } @else {
                                            <i class="pi pi-circle text-xl"></i>
                                        }
                                    </div>

                                    <span class="font-bold text-sm text-center leading-tight">
                        {{ tipo.label }}
                    </span>

                                    @if (registroForm.get('tipoAccion')?.value === tipo.value) {
                                        <div class="absolute top-2 right-2">
                                            <i class="pi pi-check-circle text-blue-500"></i>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        <input type="hidden" formControlName="tipoAccion">
                    </div>



                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start pt-2">

                        @if (registroForm.get('tipoAccion')?.value === 'iniciarPausa') {
                            <div class="w-full animate-fade-in-down">
                                <label for="tipo-pausa" class="block text-sm font-medium text-slate-700 mb-2">
                                    Tipo de Pausa
                                </label>
                                <p-select
                                    formControlName="tipoPausa"
                                    [options]="tiposPausa"
                                    optionLabel="label"
                                    optionValue="value"
                                    placeholder="Seleccione tipo de pausa"
                                    class="w-full">
                                </p-select>
                            </div>
                        }
                        @if (registroForm.get('tipoAccion')?.value === 'finalizarPausa' && empleadoBuscado()?.tipoPausa) {
                            <div class="w-full">
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    Tipo de Pausa Activa
                                </label>
                                <div class="w-full h-11 px-3 py-2 bg-gray-50 border border-slate-200 rounded-lg text-slate-700 text-base flex items-center">
                                    {{ pausaActivaTexto() }}
                                </div>
                            </div>
                        }

                        <div class="w-full">
                            <label for="hora" class="block text-sm font-medium text-slate-700 mb-2">
                                Hora de Registro
                            </label>
                            <div class="relative">
                                <input
                                    id="hora"
                                    type="time"
                                    formControlName="hora"
                                    class="w-full h-11 pl-3 pr-10 py-2 bg-white text-slate-900 text-base transition-all outline-none shadow-sm rounded-lg"
                                    [ngClass]="{
                                        'border-red-500': registroForm.get('hora')?.invalid && registroForm.get('hora')?.touched,
                                        'border-slate-200 focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600': !(registroForm.get('hora')?.invalid && registroForm.get('hora')?.touched)
                                    }">
                            </div>
                        </div>

                    </div>

                    <div>
                        <label for="observaciones" class="block text-sm font-medium text-slate-700 mb-2">
                            Comentario
                        </label>
                        <textarea
                            id="observaciones"
                            formControlName="observaciones"
                            class="w-full min-h-24 px-3 py-2 bg-white border text-slate-900 placeholder:text-slate-400 transition-all outline-none resize-y shadow-sm rounded-lg"
                            [ngClass]="{
                                'border-red-500': registroForm.get('observaciones')?.invalid && registroForm.get('observaciones')?.touched,
                                'border-slate-200 focus:ring-2 focus:ring-blue-600/20 focus:border-blue-600': !(registroForm.get('observaciones')?.invalid && registroForm.get('observaciones')?.touched)
                            }"
                            rows="3"
                            placeholder="Escribe el motivo de registro..."></textarea>
                    </div>

                    <p-button
                        (onClick)="agregarRegistro()"
                        [disabled]="isLoading() || !empleadoBuscado()"
                        icon="pi pi-check"
                        class="w-full"
                        label="Confirmar Registro">
                    </p-button>
                </div>
            }
        </div>
    </div>
</div>


